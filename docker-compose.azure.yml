# Azure Container Apps / ACI deployment
# Use this as reference for Azure Container Apps configuration
# Note: In Azure, you'll likely use Azure Cache for Redis and Azure Files for storage

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=production
      - CHROMA_HOST=chroma
      - CHROMA_PORT=8000
      # Azure Cache for Redis uses TLS on port 6380
      # Format: rediss://:password@hostname:6380
      - REDIS_URL=${REDIS_URL}
      - DATA_DIR=/app/data
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      - AZURE_AD_CLIENT_ID=${AZURE_AD_CLIENT_ID}
      - AZURE_AD_CLIENT_SECRET=${AZURE_AD_CLIENT_SECRET}
      - AZURE_AD_TENANT_ID=${AZURE_AD_TENANT_ID}
      - ADMIN_EMAILS=${ADMIN_EMAILS}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-large}
      - EMBEDDING_DIMENSIONS=${EMBEDDING_DIMENSIONS:-3072}
    ports:
      - "3000:3000"
    volumes:
      # In Azure, mount Azure Files share here
      - ./data/app:/app/data
    depends_on:
      - chroma

  chroma:
    image: chromadb/chroma:latest
    environment:
      - ANONYMIZED_TELEMETRY=false
      - ALLOW_RESET=false
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/chroma
    volumes:
      # In Azure, mount Azure Files share here
      - ./data/chroma:/chroma/chroma
    # ChromaDB doesn't need to be exposed externally
    # Only the app container needs access
